<apex:page standardController="STMTask__c" extensions="STM_SendTaskContent"> 
    <c:LoadingStatusSpinner />
    <!--<img src="https://cs5.salesforce.com/servlet/servlet.FileDownload?file=015O0000000MMYc" alt="Company Logo"/>-->
    <apex:sectionHeader title="STM Task" subtitle="{!STMTask__c.name}"/>
    <apex:form id="formId">
        <apex:pageMessages id="messageId" escape="false"></apex:pageMessages>
        <apex:inputHidden value="{!STMTask__c.Report_Project_Profile__c}"/>
        
        <apex:pageBlock title="Select Attachments to be sent to the Customer">
            <apex:pageBlockButtons >
                <apex:commandButton value="Send Email" action="{!sendEmail}" status="LoadingStatusSpinner" rerender="messageId,EmailBlock"/>
                <apex:commandButton value="Return" action="{!cancel}" status="LoadingStatusSpinner"/>
            </apex:pageBlockButtons>
            <apex:inputHidden value="{!STMTask__c.Account__c}" />
            <apex:pageBlockTable value="{!lstAttWrapper}" var="wrapperRec" >
                <apex:column >
                    <apex:facet name="header">
                        <apex:inputCheckbox value="{!Allselected}" onclick="checkAll(this,'checkedone')" />
                    </apex:facet>
                    <apex:inputCheckbox value="{!wrapperRec.IsChecked}" id="checkedone" />
                </apex:column>
                <apex:inputCheckbox value="{!wrapperRec.IsChecked}" label="Select"/>
                <apex:column value="{!wrapperRec.attmnt.ContentFileName}"/>
                <apex:column >
                    <apex:facet name="header">Size of Document</apex:facet>
                    <apex:outputText value="{!IF(wrapperRec.attmnt.ContentSize < 1000000,
                                                 TEXT(ROUND(wrapperRec.attmnt.ContentSize/1000,2))+' KB',
                                                 TEXT(ROUND(wrapperRec.attmnt.ContentSize/1000000,2))+' MB')}"/>
                </apex:column>
            </apex:pageBlockTable>
        </apex:pageBlock>
        
        <apex:pageBlock title="Following Contacts will be Notified" id="EmailBlock" >
            <apex:pageMessage severity="info" strength="2" 
                summary="To Modify/Delete any of the below Contacts, please go to the Report Profile associated to the task." />
            <!-- <apex:pageMessages escape="false"></apex:pageMessages> -->
            <apex:pageBlockSection rendered="{!!showContactCreation}" columns="1">
                <apex:pageBlockTable value="{!lstContactsSelected}" var="cntct" id="wtable">
                        <apex:column headerValue="First Name"><apex:outputField value="{!cntct.Contact__r.FirstName}"/></apex:column>
                        <apex:column headerValue="Last Name" ><apex:outputField value="{!cntct.Contact__r.LastName}" /></apex:column>
                        <apex:column headerValue="Email"><apex:outputField value="{!cntct.Contact__r.Email}"/></apex:column>  
                </apex:pageBlockTable>
            </apex:pageBlockSection>
            
            <apex:commandButton value="Add Contact" action="{!showContactBlock}" status="LoadingStatusSpinner" rerender="EmailBlock,messageId" rendered="{!!showContactCreation}"/>
            <apex:pageBlockSection rendered="{!showContactCreation}" columns="1">
                <apex:pageBlockTable value="{!wrappers}" var="wrapper" id="wtable">
                    <apex:column headerValue="First Name"><apex:inputField value="{!wrapper.con.FirstName}"/></apex:column>
                    <apex:column headerValue="Last Name" ><apex:inputField value="{!wrapper.con.LastName}" /></apex:column>
                    <apex:column headerValue="Email"><apex:inputField value="{!wrapper.con.Email}" required="true" /></apex:column>
                    <apex:column headerValue="Action">
                        <apex:commandButton value="Delete" action="{!delWrapper}" rerender="wtable" immediate="true">
                           <apex:param name="toDelIdent" value="{!wrapper.ident}" assignTo="{!toDelIdent}"/> 
                        </apex:commandButton>
                    </apex:column>
                </apex:pageBlockTable>
                <apex:outputPanel >
                    <apex:commandButton value="Add Row" action="{!addRows}" rerender="wtable,messageId" status="LoadingStatusSpinner" immediate="True">
                        <apex:param name="addCount" value="1" assignTo="{!addCount}"/> 
                    </apex:commandButton>
                    <apex:commandButton value="Add 5 Rows" action="{!addRows}" rerender="wtable,messageId" status="LoadingStatusSpinner" immediate="True">
                        <apex:param name="addCount" value="5" assignTo="{!addCount}"/> 
                    </apex:commandButton>
                    <apex:commandButton value="Save" action="{!saveContacts}" status="LoadingStatusSpinner" rerender="EmailBlock,messageId"/>
                    <apex:commandButton value="Return" status="LoadingStatusSpinner" rerender="EmailBlock,messageId" immediate="True">
                        <apex:param name="showContactCreation" value="False" assignTo="{!showContactCreation}"/> 
                    </apex:commandButton>
                </apex:outputPanel>
            </apex:pageBlockSection>
            
        </apex:pageBlock>
    </apex:form>
    
    <script type="text/javascript">
        function checkAll(cb,cbid){
            var inputElem = document.getElementsByTagName("input");                    
            for(var i=0; i<inputElem.length; i++){            
                 if(inputElem[i].id.indexOf(cbid)!=-1){                                       
                    inputElem[i].checked = cb.checked;
                }
            }
        }
        
    </script>
</apex:page>