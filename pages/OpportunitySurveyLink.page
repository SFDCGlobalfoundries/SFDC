<!-- 
Type Name: OpportunitySurveyLink.page
Author: Cognizant 
Created Date: 5/31/2014 
Reason:
Change History:
Author: 
Modified Date: 
Reason: 
-->
<apex:page standardController="Opportunity" extensions="OpportunitySurveyExtention" showHeader="false" showChat="false" sidebar="false" >
<script type="text/javascript" src="/soap/ajax/29.0/connection.js"></script>
<script type="text/javascript" language="javascript">        
        
       
        window.onload=function()
        { 
            try {
                 
                //var currentUser = sforce.connection.getUserInfo();
                var userId = "{!$User.Id}";
                var ownerId = "{!Opportunity.OwnerId}";
                
                if(userId.substring(0,15) == ownerId.substring(0,15)){
                    var surveyFor = "{!Opportunity.SurveyFor__c}";                                
                    var isSurvey = 'false';
                    
                    if (surveyFor == 'Void' || surveyFor == 'Dropped' || surveyFor == 'Lost') {
                        isSurvey = '{!doesSurveyExists}';//validate_Survey();
                    }
                    
                    if (isSurvey != 'false') {
                        var alertmsg = '{!$Label.OpportunitySurvey_AlertMessage}';
                        window.alert(alertmsg);
                    }
                }
                
                
            }
            catch (error)
            {
                 alert(error);
            }
        };
      
        function validate_Survey() {
        
            var myquery = "SELECT count()  FROM OpportunitySurvey__c WHERE Opportunity__c = '{!Opportunity.Id}' AND SurveyFor__c='{!Opportunity.SurveyFor__c}' AND Record_Owner__c ='{!Opportunity.OwnerId}'";
            var result = sforce.connection.query(myquery);
            var records = result.getArray("records");                    
            
            if (result.size > 0) {
                 return false; 
            }else{
                 return true; 
            }

        };    
        
    </script>

<apex:panelGrid style="padding:1px;margin-bottom:5px;border-radius:2px" columns="1" bgcolor="#DCFBDC" width="100%" >  
<apex:form >
<table id="table1" width="100%" >
                <tbody>
                    <tr>
                        <td  style="font-weight:bold;width: 25%" align='right'>                            
                            {!$Label.OpportunitySurvey_Design_Win_Loss_Survey} Exists :
                        </td>
                        <td  style="width: 25%">
                            <apex:outputText value="{!message}"/>    
                        </td>
                        <td  style="width: 25%">
                            <apex:outputLink value="{!surveyURL}" rendered="{!IF( isOwner , true , false)}" target="_blank">Create\Edit {!$Label.OpportunitySurvey_Design_Win_Loss_Survey}</apex:outputLink> </td>  
                        <td  style="width: 25%">
                            <apex:outputLink value="{!reportURL}" rendered="{!IF( message=='Yes', true , false)}" target="_blank">View {!$Label.OpportunitySurvey_Design_Win_Loss_Survey} Result</apex:outputLink>                                                   
                        </td>
                    </tr>                  
                </tbody>
            </table> 
      </apex:form>
   </apex:panelGrid> 
</apex:page>